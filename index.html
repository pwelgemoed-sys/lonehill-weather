<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PietWittboy Weather Station</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3a;
            --bg-card: rgba(20, 27, 58, 0.8);
            --text-primary: #e8edf4;
            --text-secondary: #8b9bb8;
            --accent-blue: #4a9eff;
            --accent-warm: #ff6b4a;
            --accent-green: #4ade80;
            --accent-purple: #a78bfa;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(74, 158, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(167, 139, 250, 0.1) 0%, transparent 50%);
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            margin-bottom: 12px;
            animation: slideDown 0.6s ease;
            position: relative;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .station-name {
            font-weight: 700;
            font-size: 2.2em;
            letter-spacing: -0.5px;
            margin-bottom: 0;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Settings Gear */
        .settings-container {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
        }

        .settings-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2em;
        }

        .settings-icon:hover {
            background: rgba(74, 158, 255, 0.2);
            border-color: var(--accent-blue);
            transform: rotate(90deg);
        }

        .settings-panel {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            min-width: 280px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px var(--shadow);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .settings-panel.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .settings-item {
            margin-bottom: 15px;
        }

        .settings-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .settings-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.5);
        }

        .settings-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.5);
        }

        .settings-slider::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .settings-slider::-moz-range-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .settings-value {
            display: inline-block;
            margin-left: 10px;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .temp-unit-toggle {
            display: flex;
            gap: 10px;
        }

        .temp-unit-btn {
            flex: 1;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .temp-unit-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .refresh-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--accent-purple);
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Refreshing indicator */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .refreshing-indicator {
            display: none;
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85em;
            color: var(--accent-blue);
            backdrop-filter: blur(10px);
            z-index: 200;
            gap: 8px;
            align-items: center;
        }

        .refreshing-indicator.visible {
            display: flex;
        }

        .refreshing-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Hero Section - Current Conditions */
        .hero-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
            animation: fadeIn 0.8s ease 0.2s both;
        }

        .hero-main {
            background: linear-gradient(135deg, var(--bg-card), rgba(74, 158, 255, 0.05));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .hero-main::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(74, 158, 255, 0.15), transparent);
            border-radius: 50%;
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .current-temp {
            font-weight: 200;
            font-size: 4.5em;
            line-height: 0.9;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .weather-icon {
            font-size: 0.8em;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .temp-trend {
            font-size: 0.4em;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
        }

        .temp-trend.rising { color: var(--accent-warm); }
        .temp-trend.falling { color: var(--accent-blue); }
        .temp-trend.steady { color: var(--text-secondary); }

        .temp-unit {
            font-size: 0.4em;
            color: var(--text-secondary);
            margin-left: 10px;
        }

        .feels-like {
            font-size: 1em;
            color: var(--text-secondary);
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .condition-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .condition-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .condition-value {
            font-size: 1.8em;
            font-weight: 600;
        }

        .uv-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .uv-bar {
            width: 80px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }

        .uv-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .uv-low { background: var(--accent-green); }
        .uv-moderate { background: #fbbf24; }
        .uv-high { background: var(--accent-warm); }
        .uv-very-high { background: #dc2626; }
        .uv-extreme { background: #7c2d12; }

        /* Indoor/Outdoor Comparison */
        .comparison-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .comparison-title {
            font-size: 0.95em;
            margin-bottom: 20px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .comparison-item { margin-bottom: 22px; }
        .comparison-item:last-child { margin-bottom: 0; }

        .comparison-label {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .comparison-values {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .value-block { flex: 1; }

        .value-type {
            font-size: 0.7em;
            color: var(--accent-blue);
            margin-bottom: 5px;
        }

        .value-number {
            font-size: 1.9em;
            font-weight: 300;
        }

        .value-divider {
            width: 2px;
            height: 35px;
            background: var(--border);
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 12px;
            animation: fadeIn 0.8s ease 0.4s both;
        }

        .data-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .data-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .data-card:hover::after { transform: translateX(100%); }

        .data-card:hover {
            transform: translateY(-5px);
            border-color: rgba(74, 158, 255, 0.3);
            box-shadow: 0 20px 40px var(--shadow);
        }

        .data-icon {
            font-size: 1.6em;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .data-label {
            color: var(--text-secondary);
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .data-value {
            font-size: 2em;
            font-weight: 300;
            line-height: 1;
        }

        .data-unit {
            font-size: 0.4em;
            color: var(--text-secondary);
            margin-left: 5px;
        }

        .data-subtitle {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-top: 8px;
        }

        .pressure-trend {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            font-size: 0.5em;
            color: var(--text-secondary);
        }

        .trend-arrow { font-size: 1.2em; }
        .trend-rising { color: var(--accent-warm); }
        .trend-falling { color: var(--accent-blue); }
        .trend-steady { color: var(--text-secondary); }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
            animation: fadeIn 0.8s ease 0.6s both;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            backdrop-filter: blur(10px);
        }

        .chart-card canvas { max-height: 200px; }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .chart-period {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        /* Wind Rose */
        .wind-rose {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .wind-compass {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 2px solid var(--border);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wind-direction-arrow {
            position: absolute;
            font-size: 3.5em;
            transition: all 0.5s ease;
            filter: drop-shadow(0 0 20px var(--accent-blue));
            z-index: 2;
            left: 50%;
            top: 50%;
            margin-left: -0.25em;
            margin-top: -0.5em;
        }

        .wind-direction-arrow-avg {
            position: absolute;
            font-size: 4.2em;
            transition: all 0.5s ease;
            color: transparent;
            -webkit-text-stroke: 2px rgba(74, 158, 255, 0.5);
            filter: drop-shadow(0 0 15px rgba(74, 158, 255, 0.3));
            z-index: 1;
            animation: dashPulse 2s ease-in-out infinite;
            left: 50%;
            top: 50%;
            margin-left: -0.3em;
            margin-top: -0.6em;
        }

        @keyframes dashPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.9; }
        }

        .compass-marker {
            position: absolute;
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .compass-n { top: 8px; left: 50%; transform: translateX(-50%); }
        .compass-e { right: 8px; top: 50%; transform: translateY(-50%); }
        .compass-s { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .compass-w { left: 8px; top: 50%; transform: translateY(-50%); }

        .wind-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 3;
        }

        .wind-direction-label {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .wind-degrees {
            font-size: 1em;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Bottom Grid */
        .bottom-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            animation: fadeIn 0.8s ease 0.8s both;
        }

        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 100px 20px;
            font-size: 1.5em;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-banner {
            background: rgba(255, 107, 74, 0.1);
            border: 1px solid var(--accent-warm);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: var(--accent-warm);
            display: none;
        }

        /* Last Update */
        .last-update {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 20px;
            font-size: 0.85em;
            animation: fadeIn 0.8s ease 1s both;
            display: none;
        }

        /* Simulated data notice */
        .simulated-notice {
            display: none;
            font-size: 0.75em;
            color: var(--accent-warm);
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .hero-grid { grid-template-columns: 1fr; }
            .data-grid { grid-template-columns: repeat(4, 1fr); }
            .data-card:nth-child(5) { display: none; }
            .charts-section { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .station-name { font-size: 2em; }
            .current-temp { font-size: 4em; }
            .data-grid { grid-template-columns: repeat(2, 1fr); }
            .data-card:nth-child(5) { display: none; }
            .bottom-grid { grid-template-columns: 1fr; }
            .hero-main { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="station-name">Lonehill Weather</h1>

            <div class="settings-container">
                <div class="settings-icon" id="settings-icon" role="button" aria-label="Settings">‚öôÔ∏è</div>
                <div class="settings-panel" id="settings-panel" role="dialog" aria-label="Settings panel">
                    <div class="settings-title">Settings</div>

                    <div class="settings-item">
                        <label class="settings-label">Temperature Unit</label>
                        <div class="temp-unit-toggle">
                            <div class="temp-unit-btn active" id="unit-c" role="button">¬∞C</div>
                            <div class="temp-unit-btn" id="unit-f" role="button">¬∞F</div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label class="settings-label" for="refresh-slider">
                            Auto Refresh Interval
                            <span class="settings-value" id="refresh-value">5 min</span>
                        </label>
                        <input type="range" class="settings-slider" id="refresh-slider"
                               min="1" max="15" value="5" step="1">
                    </div>

                    <div class="settings-item">
                        <button class="refresh-btn" id="manual-refresh">üîÑ Refresh Now</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Soft-refresh indicator (replaces page flash) -->
        <div class="refreshing-indicator" id="refreshing-indicator">
            <div class="refreshing-spinner"></div>
            <span>Updating...</span>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div>Connecting to weather station...</div>
        </div>

        <div id="error-banner" class="error-banner" role="alert"></div>

        <div id="main-content" style="display: none;">
            <!-- Hero Section -->
            <div class="hero-grid">
                <div class="hero-main">
                    <div class="current-temp">
                        <span id="weather-icon" class="weather-icon">‚òÄÔ∏è</span>
                        <span id="current-temp">--<span class="temp-unit">¬∞C</span></span>
                    </div>
                    <div class="feels-like" id="feels-like">Feels like --¬∞C</div>
                    <div class="conditions-grid">
                        <div class="condition-item">
                            <div class="condition-label">Humidity</div>
                            <div class="condition-value" id="hero-humidity">--%</div>
                        </div>
                        <div class="condition-item">
                            <div class="condition-label">Pressure</div>
                            <div class="condition-value" id="hero-pressure">---- hPa</div>
                        </div>
                        <div class="condition-item">
                            <div class="condition-label">Wind</div>
                            <div class="condition-value" id="hero-wind">-- km/h</div>
                        </div>
                        <div class="condition-item">
                            <div class="condition-label">UV Index</div>
                            <div class="uv-container">
                                <div class="condition-value" id="hero-uv">-</div>
                                <div class="uv-bar">
                                    <div class="uv-fill" id="uv-bar-fill"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="comparison-title">In/Out</div>

                    <div class="comparison-item">
                        <div class="comparison-label">Temperature</div>
                        <div class="comparison-values">
                            <div class="value-block">
                                <div class="value-type">OUT</div>
                                <div class="value-number" id="out-temp">--¬∞</div>
                            </div>
                            <div class="value-divider"></div>
                            <div class="value-block">
                                <div class="value-type" style="color: var(--accent-warm)">IN</div>
                                <div class="value-number" id="in-temp">--¬∞</div>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-item">
                        <div class="comparison-label">Humidity</div>
                        <div class="comparison-values">
                            <div class="value-block">
                                <div class="value-type">OUT</div>
                                <div class="value-number" id="out-humidity">--%</div>
                            </div>
                            <div class="value-divider"></div>
                            <div class="value-block">
                                <div class="value-type" style="color: var(--accent-warm)">IN</div>
                                <div class="value-number" id="in-humidity">--%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Grid -->
            <div class="data-grid">
                <div class="data-card">
                    <div class="data-icon">üíß</div>
                    <div class="data-label">Dew Point</div>
                    <div class="data-value" id="dew-point">--<span class="data-unit">¬∞C</span></div>
                </div>

                <div class="data-card">
                    <div class="data-icon">üåßÔ∏è</div>
                    <div class="data-label">Rain Today</div>
                    <div class="data-value" id="rain-today">--<span class="data-unit">mm</span></div>
                    <div class="data-subtitle" id="rain-rate">-- mm/hr</div>
                </div>

                <div class="data-card">
                    <div class="data-icon">‚òÄÔ∏è</div>
                    <div class="data-label">Solar Radiation</div>
                    <div class="data-value" id="solar-rad">--<span class="data-unit">W/m¬≤</span></div>
                </div>

                <div class="data-card">
                    <div class="data-icon">üå™Ô∏è</div>
                    <div class="data-label">Wind Gust</div>
                    <div class="data-value" id="wind-gust">--<span class="data-unit">km/h</span></div>
                </div>

                <div class="data-card">
                    <div class="data-icon">üîã</div>
                    <div class="data-label">Sensor Battery</div>
                    <div class="data-value" id="battery-status">--<span class="data-unit">V</span></div>
                    <div class="data-subtitle" id="battery-level">--</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Temperature & Humidity</div>
                        <div class="chart-period">24 Hours <span class="simulated-notice" id="temp-chart-notice">‚ö† simulated</span></div>
                    </div>
                    <canvas id="temp-humidity-chart"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Wind Direction</div>
                        <div class="chart-period"></div>
                    </div>
                    <div class="wind-rose">
                        <div class="wind-compass">
                            <div class="compass-marker compass-n">N</div>
                            <div class="compass-marker compass-e">E</div>
                            <div class="compass-marker compass-s">S</div>
                            <div class="compass-marker compass-w">W</div>
                            <div class="wind-direction-arrow-avg" id="wind-arrow-avg">‚û§</div>
                            <div class="wind-direction-arrow" id="wind-arrow">‚û§</div>
                            <div class="wind-center-text">
                                <div class="wind-direction-label" id="wind-compass-label">---</div>
                                <div class="wind-degrees" id="wind-degrees-label">---¬∞</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Grid -->
            <div class="bottom-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Atmospheric Pressure</div>
                        <div class="chart-period">24 Hours <span class="simulated-notice" id="pressure-chart-notice">‚ö† simulated</span></div>
                    </div>
                    <canvas id="pressure-chart"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Rainfall</div>
                        <div class="chart-period">This Month: <span id="rain-monthly">--</span> mm</div>
                    </div>
                    <canvas id="rainfall-chart"></canvas>
                </div>
            </div>
        </div>

        <div id="last-update" class="last-update"></div>
    </div>

    <script>
        // ---------------------------------------------------------------------------
        // State
        // ---------------------------------------------------------------------------
        let charts = {};
        let refreshTimer = null;
        let lastFetchedData = null; // cache so unit toggle doesn't re-fetch

        const preferences = {
            tempUnit: localStorage.getItem('tempUnit') || 'C',
            refreshInterval: parseInt(localStorage.getItem('refreshInterval')) || 5,
        };

        // ---------------------------------------------------------------------------
        // Unit helpers
        // ---------------------------------------------------------------------------
        const fToC  = (f) => (f - 32) * 5 / 9;
        const cToF  = (c) => c * 9 / 5 + 32;
        const mphToKmh = (mph) => mph * 1.60934;
        const inHgToHPa = (inHg) => inHg * 33.8639;
        const inToMm = (inches) => inches * 25.4;

        function convertTemp(tempC) {
            return preferences.tempUnit === 'F' ? cToF(tempC) : tempC;
        }

        function getTempUnit() {
            return preferences.tempUnit === 'F' ? '¬∞F' : '¬∞C';
        }

        // ---------------------------------------------------------------------------
        // Safe Value extraction ‚Äî returns null instead of 0 for missing data
        // ---------------------------------------------------------------------------
        function getValue(obj) {
            if (obj == null || obj.value == null || obj.value === '') return null;
            const n = parseFloat(obj.value);
            return isNaN(n) ? null : n;
        }

        // Format a value or return a placeholder string
        function fmt(val, decimals = 1, fallback = '--') {
            return val !== null ? val.toFixed(decimals) : fallback;
        }

        // ---------------------------------------------------------------------------
        // Compass / condition helpers
        // ---------------------------------------------------------------------------
        function getCompassDirection(degrees) {
            const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            return dirs[Math.round(degrees / 22.5) % 16];
        }

        function getWeatherCondition(solarRad, rainRate) {
            if (rainRate !== null && rainRate > 0) return { icon: 'üåßÔ∏è', name: 'Rainy' };
            if (solarRad === null || solarRad === 0) return { icon: 'üåô', name: 'Night' };
            if (solarRad < 200)  return { icon: '‚òÅÔ∏è', name: 'Cloudy' };
            if (solarRad < 500)  return { icon: '‚õÖ', name: 'Partly Cloudy' };
            return { icon: '‚òÄÔ∏è', name: 'Sunny' };
        }

        function getUVClass(uvIndex) {
            if (uvIndex === null) return { class: '', width: 0 };
            if (uvIndex < 3)  return { class: 'uv-low',       width: (uvIndex / 11) * 100 };
            if (uvIndex < 6)  return { class: 'uv-moderate',  width: (uvIndex / 11) * 100 };
            if (uvIndex < 8)  return { class: 'uv-high',      width: (uvIndex / 11) * 100 };
            if (uvIndex < 11) return { class: 'uv-very-high', width: (uvIndex / 11) * 100 };
            return { class: 'uv-extreme', width: 100 };
        }

        // ---------------------------------------------------------------------------
        // Trend calculation ‚Äî uses KV history supplied by the server
        // ---------------------------------------------------------------------------
        function calculateTrendFromHistory(historyArray, windowMs) {
            if (!historyArray || historyArray.length < 2) {
                return { trend: 'steady', text: '', cssClass: 'steady' };
            }
            const cutoff = Date.now() - windowMs;
            const recent = historyArray.filter(p => p.time > cutoff);
            if (recent.length < 2) return { trend: 'steady', text: '', cssClass: 'steady' };

            const diff = recent[recent.length - 1].value - recent[0].value;
            return diff > 0.5
                ? { trend: 'rising',  text: '‚Üó', cssClass: 'rising'  }
                : diff < -0.5
                ? { trend: 'falling', text: '‚Üò', cssClass: 'falling' }
                : { trend: 'steady',  text: '',   cssClass: 'steady'  };
        }

        function calculatePressureTrendFromHistory(historyArray) {
            if (!historyArray || historyArray.length < 2) {
                return { trend: 'steady', text: '‚Äî', cssClass: 'trend-steady' };
            }
            const threeHours = 3 * 3600 * 1000;
            const cutoff = Date.now() - threeHours;
            const recent = historyArray.filter(p => p.time > cutoff);
            if (recent.length < 2) return { trend: 'steady', text: '‚Äî', cssClass: 'trend-steady' };

            const diff = recent[recent.length - 1].value - recent[0].value;
            return diff > 1.0
                ? { trend: 'rising',  text: '‚Üë', cssClass: 'trend-rising'  }
                : diff < -1.0
                ? { trend: 'falling', text: '‚Üì', cssClass: 'trend-falling' }
                : { trend: 'steady',  text: '‚Üí', cssClass: 'trend-steady'  };
        }

        // ---------------------------------------------------------------------------
        // Data fetch ‚Äî single call to our Cloudflare Worker proxy
        // ---------------------------------------------------------------------------
        async function fetchAllData() {
            const response = await fetch('/api/weather');
            if (!response.ok) {
                const body = await response.json().catch(() => ({}));
                throw new Error(body.error || `HTTP ${response.status}`);
            }
            return response.json();
        }

        // ---------------------------------------------------------------------------
        // Display
        // ---------------------------------------------------------------------------
        function displayCurrentConditions(data, trends) {
            const outdoor  = data.realtime?.outdoor  || {};
            const indoor   = data.realtime?.indoor   || {};
            const wind     = data.realtime?.wind      || {};
            const pressure = data.realtime?.pressure  || {};
            const rainfall = data.realtime?.rainfall_piezo || data.realtime?.rainfall || {};
            const solar    = data.realtime?.solar_and_uvi || {};
            const battery  = data.realtime?.battery   || {};

            // Temperatures (API returns ¬∞F, already stored as ¬∞C in trends)
            const rawTempF     = getValue(outdoor.temperature);
            const tempC        = rawTempF !== null ? fToC(rawTempF) : null;
            const temp         = tempC !== null ? convertTemp(tempC) : null;

            const rawFeelsF    = getValue(outdoor.feels_like);
            const feelsLike    = rawFeelsF !== null ? convertTemp(fToC(rawFeelsF)) : null;

            const rawIndoorF   = getValue(indoor.temperature);
            const indoorTemp   = rawIndoorF !== null ? convertTemp(fToC(rawIndoorF)) : null;

            const humidity     = getValue(outdoor.humidity);
            const indoorHum    = getValue(indoor.humidity);
            const pressureVal  = (() => { const v = getValue(pressure.relative); return v !== null ? inHgToHPa(v) : null; })();
            const windSpeed    = (() => { const v = getValue(wind.wind_speed);   return v !== null ? mphToKmh(v)  : null; })();
            const windGust     = (() => { const v = getValue(wind.wind_gust);    return v !== null ? mphToKmh(v)  : null; })();
            const uv           = getValue(solar.uvi);
            const solarRad     = getValue(solar.solar);
            const rainRate     = (() => { const v = getValue(rainfall.rain_rate); return v !== null ? inToMm(v) : null; })();
            const rainToday    = (() => { const v = getValue(rainfall.daily);     return v !== null ? inToMm(v) : null; })();
            const rainMonthly  = (() => { const v = getValue(rainfall.monthly);   return v !== null ? inToMm(v) : null; })();
            const dewPointC    = (() => { const v = getValue(outdoor.dew_point);  return v !== null ? fToC(v)   : null; })();
            const dewPoint     = dewPointC !== null ? convertTemp(dewPointC) : null;
            const batteryV     = getValue(battery.haptic_array_battery);

            // Trends from KV history
            const tempTrend     = calculateTrendFromHistory(trends?.temperature, 3600000);
            const pressureTrend = calculatePressureTrendFromHistory(trends?.pressure);

            // Weather icon
            const weather = getWeatherCondition(solarRad, rainRate);
            document.getElementById('weather-icon').textContent = weather.icon;

            // Main temperature
            const tempTrendHTML = tempTrend.text
                ? `<span class="temp-trend ${tempTrend.cssClass}">${tempTrend.text}</span>`
                : '';
            document.getElementById('current-temp').innerHTML =
                `${fmt(temp)}<span class="temp-unit">${getTempUnit()}</span>${tempTrendHTML}`;

            document.getElementById('feels-like').textContent =
                feelsLike !== null ? `Feels like ${fmt(feelsLike)}${getTempUnit()}` : 'Feels like --';

            document.getElementById('hero-humidity').textContent =
                humidity !== null ? `${fmt(humidity, 0)}%` : '--%';

            // Pressure with trend
            const ptHTML = pressureTrend.text
                ? `<span class="pressure-trend ${pressureTrend.cssClass}"><span class="trend-arrow">${pressureTrend.text}</span></span>`
                : '';
            document.getElementById('hero-pressure').innerHTML =
                pressureVal !== null ? `${fmt(pressureVal)} hPa${ptHTML}` : '---- hPa';

            document.getElementById('hero-wind').textContent =
                windSpeed !== null ? `${fmt(windSpeed)} km/h` : '-- km/h';

            // UV bar
            const uvNum = uv !== null ? uv : 0;
            document.getElementById('hero-uv').textContent = uv !== null ? fmt(uv, 0) : '-';
            const uvStyle = getUVClass(uv);
            const uvBarFill = document.getElementById('uv-bar-fill');
            uvBarFill.className = `uv-fill ${uvStyle.class}`;
            uvBarFill.style.width = `${uvStyle.width}%`;

            // In/Out comparison
            document.getElementById('out-temp').textContent    = temp     !== null ? `${fmt(temp)}¬∞`     : '--¬∞';
            document.getElementById('in-temp').textContent     = indoorTemp !== null ? `${fmt(indoorTemp)}¬∞` : '--¬∞';
            document.getElementById('out-humidity').textContent = humidity  !== null ? `${fmt(humidity, 0)}%` : '--%';
            document.getElementById('in-humidity').textContent  = indoorHum !== null ? `${fmt(indoorHum, 0)}%` : '--%';

            // Data cards
            document.getElementById('dew-point').innerHTML =
                `${fmt(dewPoint)}<span class="data-unit">${getTempUnit()}</span>`;
            document.getElementById('rain-today').innerHTML =
                `${fmt(rainToday)}<span class="data-unit">mm</span>`;
            document.getElementById('rain-rate').textContent =
                rainRate !== null ? `${fmt(rainRate)} mm/hr` : '-- mm/hr';
            document.getElementById('solar-rad').innerHTML =
                `${fmt(solarRad, 0)}<span class="data-unit">W/m¬≤</span>`;
            document.getElementById('wind-gust').innerHTML =
                `${fmt(windGust)}<span class="data-unit">km/h</span>`;
            document.getElementById('rain-monthly').textContent =
                rainMonthly !== null ? fmt(rainMonthly) : '--';

            // Battery
            let batteryLevel = '--';
            let batteryColor = 'var(--text-secondary)';
            if (batteryV !== null) {
                if (batteryV < 2.6)      { batteryLevel = 'Low';  batteryColor = 'var(--accent-warm)';  }
                else if (batteryV < 2.9) { batteryLevel = 'Fair'; batteryColor = 'var(--accent-blue)';  }
                else                      { batteryLevel = 'Good'; batteryColor = 'var(--accent-green)'; }
            }
            document.getElementById('battery-status').innerHTML =
                batteryV !== null ? `${fmt(batteryV, 2)}<span class="data-unit">V</span>` : `--<span class="data-unit">V</span>`;
            document.getElementById('battery-level').innerHTML =
                `<span style="color: ${batteryColor}">${batteryLevel}</span>`;

            // Wind compass
            const windDir    = getValue(wind.wind_direction);
            const windDirAvg = getValue(wind['10_minute_average_wind_direction']);
            const arrowOffset = 90;

            if (windDir !== null) {
                const compassLabel = getCompassDirection(windDir);
                const windFromRad  = (windDir - 90) * Math.PI / 180;
                const arrowX = Math.cos(windFromRad) * arrowOffset;
                const arrowY = Math.sin(windFromRad) * arrowOffset;
                const windToDir = (windDir + 180) % 360;
                document.getElementById('wind-arrow').style.transform =
                    `translate(${arrowX}px, ${arrowY}px) rotate(${windToDir - 90}deg)`;
                document.getElementById('wind-compass-label').textContent = compassLabel;
                document.getElementById('wind-degrees-label').textContent = `${fmt(windDir, 0)}¬∞`;
            }

            if (windDirAvg !== null) {
                const windFromRadAvg = (windDirAvg - 90) * Math.PI / 180;
                const arrowXAvg = Math.cos(windFromRadAvg) * arrowOffset;
                const arrowYAvg = Math.sin(windFromRadAvg) * arrowOffset;
                const windToDirAvg = (windDirAvg + 180) % 360;
                document.getElementById('wind-arrow-avg').style.transform =
                    `translate(${arrowXAvg}px, ${arrowYAvg}px) rotate(${windToDirAvg - 90}deg)`;
            }
        }

        // ---------------------------------------------------------------------------
        // Charts ‚Äî now respects current temp unit preference
        // ---------------------------------------------------------------------------
        function createTempHumidityChart(historyData, realtimeData) {
            const ctx = document.getElementById('temp-humidity-chart').getContext('2d');
            if (charts.tempHumidity) charts.tempHumidity.destroy();

            let labels = [], temps = [], humidity = [];
            let isSimulated = false;

            if (historyData?.outdoor?.temperature) {
                const tempList = historyData.outdoor.temperature.list || [];
                const humList  = historyData.outdoor.humidity?.list  || [];
                labels   = tempList.map(d => new Date(d.time * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                temps    = tempList.map(d => convertTemp(fToC(parseFloat(d.value))));
                humidity = humList.map(d => parseFloat(d.value));
            } else {
                isSimulated = true;
                const rawTempF = getValue(realtimeData?.outdoor?.temperature);
                const currentTemp = rawTempF !== null ? convertTemp(fToC(rawTempF)) : 20;
                const currentHum  = getValue(realtimeData?.outdoor?.humidity) ?? 60;
                for (let i = 24; i >= 0; i--) {
                    const date = new Date(Date.now() - i * 3600000);
                    const hour = date.getHours();
                    labels.push(date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                    temps.push(currentTemp - 2 + 3 * Math.sin((hour - 6) * Math.PI / 12) + (Math.random() - 0.5));
                    humidity.push(currentHum + (Math.random() - 0.5) * 10);
                }
            }

            document.getElementById('temp-chart-notice').style.display = isSimulated ? 'inline' : 'none';
            const tempLabel = `Temperature (${getTempUnit()})`;

            charts.tempHumidity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: tempLabel,
                            data: temps,
                            borderColor: '#4a9eff',
                            backgroundColor: 'rgba(74, 158, 255, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 6,
                        },
                        {
                            label: 'Humidity (%)',
                            data: humidity,
                            borderColor: '#a78bfa',
                            backgroundColor: 'rgba(167, 139, 250, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 6,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#8b9bb8', font: { size: 12 } } } },
                    scales: {
                        x: { ticks: { color: '#8b9bb8', maxTicksLimit: 8 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y:  { type: 'linear', display: true, position: 'left',  ticks: { color: '#4a9eff' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#a78bfa' }, grid: { drawOnChartArea: false } },
                    },
                },
            });
        }

        function createPressureChart(historyData, realtimeData) {
            const ctx = document.getElementById('pressure-chart').getContext('2d');
            if (charts.pressure) charts.pressure.destroy();

            let labels = [], pressureData = [];
            let isSimulated = false;

            if (historyData?.pressure?.relative) {
                const list = historyData.pressure.relative.list || [];
                labels       = list.map(d => new Date(d.time * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                pressureData = list.map(d => inHgToHPa(parseFloat(d.value)));
            } else {
                isSimulated = true;
                const rawP = getValue(realtimeData?.pressure?.relative);
                const currentPress = rawP !== null ? inHgToHPa(rawP) : 1013;
                for (let i = 24; i >= 0; i--) {
                    const date = new Date(Date.now() - i * 3600000);
                    labels.push(date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                    pressureData.push(currentPress + (Math.random() - 0.5) * 5);
                }
            }

            document.getElementById('pressure-chart-notice').style.display = isSimulated ? 'inline' : 'none';

            charts.pressure = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Pressure (hPa)',
                        data: pressureData,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#8b9bb8', maxTicksLimit: 8 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#4ade80' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    },
                },
            });
        }

        function createRainfallChart(realtimeData) {
            const ctx = document.getElementById('rainfall-chart').getContext('2d');
            if (charts.rainfall) charts.rainfall.destroy();

            const rainfall = realtimeData?.rainfall_piezo || realtimeData?.rainfall || {};
            const toMm = (key) => { const v = getValue(rainfall[key]); return v !== null ? inToMm(v) : 0; };

            const values = [
                toMm('daily'), toMm('event'), toMm('1_hour'),
                toMm('24_hours'), toMm('weekly'), toMm('monthly'), toMm('yearly'),
            ];

            charts.rainfall = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Today', 'Event', '1 Hour', '24 Hours', 'Week', 'Month', 'Year'],
                    datasets: [{
                        label: 'Rainfall (mm)',
                        data: values,
                        backgroundColor: [
                            'rgba(74,158,255,0.6)', 'rgba(74,158,255,0.6)',
                            'rgba(74,158,255,0.6)', 'rgba(74,158,255,0.6)',
                            'rgba(167,139,250,0.6)', 'rgba(167,139,250,0.8)',
                            'rgba(255,107,74,0.6)',
                        ],
                        borderColor: ['#4a9eff','#4a9eff','#4a9eff','#4a9eff','#a78bfa','#a78bfa','#ff6b4a'],
                        borderWidth: 2,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#8b9bb8' }, grid: { display: false } },
                        y: { ticks: { color: '#8b9bb8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    },
                },
            });
        }

        // ---------------------------------------------------------------------------
        // Refresh logic ‚Äî soft update, no page reload
        // ---------------------------------------------------------------------------
        function showRefreshIndicator(visible) {
            const el = document.getElementById('refreshing-indicator');
            el.classList.toggle('visible', visible);
        }

        function showError(message) {
            const banner = document.getElementById('error-banner');
            // Use textContent for the message to prevent XSS, then wrap in safe HTML
            banner.textContent = '';
            const strong = document.createElement('strong');
            strong.textContent = 'Connection Error: ';
            const span = document.createElement('span');
            span.textContent = message; // safe ‚Äî never rendered as HTML
            banner.appendChild(strong);
            banner.appendChild(span);
            banner.style.display = 'block';
        }

        function hideError() {
            const banner = document.getElementById('error-banner');
            banner.textContent = '';
            banner.style.display = 'none';
        }

        async function refreshData(isInitial = false) {
            const refreshBtn = document.getElementById('manual-refresh');
            refreshBtn.disabled = true;

            if (!isInitial) showRefreshIndicator(true);

            try {
                const data = await fetchAllData();
                lastFetchedData = data;

                hideError();

                if (isInitial) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                }

                displayCurrentConditions(data, data.trends);
                createTempHumidityChart(data.history, data.realtime);
                createPressureChart(data.history, data.realtime);
                createRainfallChart(data.realtime);

                const lastUpdate = document.getElementById('last-update');
                lastUpdate.textContent = `Last updated: ${new Date().toLocaleString('en-ZA', { timeZone: 'Africa/Johannesburg' })}`;
                lastUpdate.style.display = 'block';

                scheduleRefresh();

            } catch (error) {
                if (isInitial) {
                    document.getElementById('loading').style.display = 'none';
                }
                showError(error.message);
                console.error('Refresh error:', error);
                scheduleRefresh(); // keep trying
            } finally {
                showRefreshIndicator(false);
                refreshBtn.disabled = false;
            }
        }

        // Re-render with the cached data using the new unit ‚Äî no API call needed
        function reRenderForUnitChange() {
            if (!lastFetchedData) return;
            displayCurrentConditions(lastFetchedData, lastFetchedData.trends);
            createTempHumidityChart(lastFetchedData.history, lastFetchedData.realtime);
            // Pressure and rainfall charts are unit-independent, no need to redraw them
        }

        function scheduleRefresh() {
            if (refreshTimer) clearTimeout(refreshTimer);
            refreshTimer = setTimeout(() => refreshData(), preferences.refreshInterval * 60000);
        }

        // ---------------------------------------------------------------------------
        // Settings panel
        // ---------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            const settingsIcon  = document.getElementById('settings-icon');
            const settingsPanel = document.getElementById('settings-panel');
            const unitC         = document.getElementById('unit-c');
            const unitF         = document.getElementById('unit-f');
            const refreshSlider = document.getElementById('refresh-slider');
            const refreshValue  = document.getElementById('refresh-value');
            const manualRefresh = document.getElementById('manual-refresh');

            // Toggle panel
            settingsIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!settingsPanel.contains(e.target) && e.target !== settingsIcon) {
                    settingsPanel.classList.remove('active');
                }
            });

            // Temperature unit toggle ‚Äî re-render in place, no reload
            function setUnit(unit) {
                preferences.tempUnit = unit;
                localStorage.setItem('tempUnit', unit);
                unitC.classList.toggle('active', unit === 'C');
                unitF.classList.toggle('active', unit === 'F');
                reRenderForUnitChange();
            }

            unitC.addEventListener('click', () => setUnit('C'));
            unitF.addEventListener('click', () => setUnit('F'));

            // Restore initial unit button state
            if (preferences.tempUnit === 'F') {
                unitF.classList.add('active');
                unitC.classList.remove('active');
            }

            // Refresh slider
            refreshSlider.value = preferences.refreshInterval;
            refreshValue.textContent = `${preferences.refreshInterval} min`;

            refreshSlider.addEventListener('input', (e) => {
                const minutes = parseInt(e.target.value);
                preferences.refreshInterval = minutes;
                localStorage.setItem('refreshInterval', minutes);
                refreshValue.textContent = `${minutes} min`;
                scheduleRefresh();
            });

            // Manual refresh button ‚Äî soft update
            manualRefresh.addEventListener('click', () => {
                settingsPanel.classList.remove('active');
                refreshData();
            });
        });

        // ---------------------------------------------------------------------------
        // Boot
        // ---------------------------------------------------------------------------
        refreshData(true);
    </script>
</body>
</html>
